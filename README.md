# 心理量表网络分析 Shiny 应用

## 简介

这是一个基于我之前写的 `toturial.R` 开发的交互式网络分析工具，专门用于心理量表数据的多层级网络可视化。应用支持常见的心理量表（如 AUDIT、HRF、PHQ 等）的自动识别和分析。

## 核心功能

### 🔍 多层级网络分析
- **汇总层**：使用量表总分或维度得分构建网络
- **子量表层**：基于各个维度得分的网络结构
- **条目层**：原始题目级别的详细网络关系

### 🌉 桥接网络分析
- **桥接节点识别**：自动识别连接不同心理构念组别的关键节点
- **变量分组配色**：支持自定义变量分组和配色方案
- **快速分组操作**：提供"全部合并"、"每个一组"、"按类型分组"等快捷功能
- **临床意义**：桥接节点通常是干预的优先目标

### 🎯 专门的变量选择系统
- **分层级选择**：每个量表可独立选择分析层级（汇总/子量表/条目）
- **实时预览**：显示最终变量配置和数据质量状态
- **智能推荐**：基于量表特性提供默认层级建议
- **质量评估**：实时显示完整观测数量和缺失值统计

### 📊 自动量表识别
支持以下心理量表的自动识别：
- **AUDIT**: 酒精使用障碍识别测试
- **HRF**: 习惯-奖赏-恐惧动机量表
- **PHQ-9**: 患者健康问卷抑郁量表
- **GAD-7**: 广泛性焦虑量表
- **BDI-II**: 贝克抑郁量表第二版
- **DASS-21**: 抑郁焦虑压力量表
- **IAT**: 网络成瘾测试
- **FTND**: 法格斯特姆烟草依赖测试

### 🛡️ 数据质量保证
- 自动数据验证和质量检查
- 缺失值处理和异常值检测
- 样本量和完整性评估

### 📈 全面的网络分析
- **网络结构可视化**：使用 quickNet 包的高质量网络图
- **中心性指标分析**：强度、接近性、介数中心性计算
- **独立稳定性分析**：使用 bootnet 包进行边稳定性和中心性稳定性检验
- **NetCompare 组间比较**：支持网络比较测试（NCT）和差异网络可视化
- **交互式参数调整**：实时调整网络阈值和Bootstrap参数

### 💾 结果导出
- 高质量网络图导出
- 分析数据下载
- HTML 格式分析报告

## 安装和运行

### 1. 环境准备

确保已安装 R (≥ 4.0.0) 和必要的包：

```r
# 安装基础包
install.packages(c("shiny", "shinydashboard", "shinyWidgets", 
                   "DT", "plotly", "readxl", "dplyr", "ggplot2", "bruceR"))

# 安装 quickNet (从 GitHub)
if (!require(devtools)) install.packages("devtools")
devtools::install_github("LeiGuo0812/quickNet")

# 安装 Bioconductor 包
if (!require("BiocManager")) install.packages("BiocManager")
BiocManager::install("Rgraphviz")
```

### 2. 启动应用

**⚠️ 重要：推荐使用安全启动脚本避免包冲突**

```r
# 方法1：安全启动（强烈推荐）
source("安全启动.R", encoding = "UTF-8")

# 方法2：完整启动脚本
source("run_app.R", encoding = "UTF-8")

# 方法3：手动启动（不推荐）
shiny::runApp(".", port = 3838)
```

**为什么要使用安全启动？**
- 避免 bruceR 包与 Shiny 的 `p()` 函数冲突
- 自动检查必要文件和依赖包
- 提供清晰的启动状态信息

启动后，浏览器会自动打开应用界面：`http://127.0.0.1:3841`

## 数据格式要求

### 📁 支持的文件格式
- CSV 文件 (`.csv`)
- Excel 文件 (`.xlsx`, `.xls`)

### 📋 数据结构
- **行**：每行代表一个被试/参与者
- **列**：每列代表一个测量指标（题目或维度得分）

### 🏷️ 变量命名规范

为了自动识别量表结构，请遵循以下命名规范：

```
量表前缀_题目编号
```

**示例：**
- AUDIT量表：`AUDIT10_1`, `AUDIT10_2`, ..., `AUDIT10_10`
- HRF量表：`HRF18_1`, `HRF18_2`, ..., `HRF18_18`
- PHQ量表：`PHQ9_1`, `PHQ9_2`, ..., `PHQ9_9`

### 📊 数据质量要求
- 最小样本量：30 个被试
- 数据完整率：≥ 70%
- 单个变量缺失率：≤ 30%

## 使用流程

### 步骤 1: 数据上传
1. 点击"数据上传"标签页
2. 选择数据文件（CSV 或 Excel 格式）
3. 确认数据包含列名
4. 查看数据预览、量表识别结果和质量检查

### 步骤 2: 变量选择 ⭐
1. 点击"变量选择"标签页
2. **为每个量表独立选择分析层级**：
   - **汇总层**：适合探索总体关系模式（AUDIT、PHQ推荐）
   - **子量表层**：适合研究维度间关系
   - **条目层**：适合详细的题目级分析（HRF推荐）
3. **配置变量分组**（可选）：
   - 默认每个量表一组
   - 可合并多个量表为一组
   - 支持"全部合并"、"每个一组"等快速操作
4. 查看**实时数据质量状态**（完整观测数、缺失值统计）
5. 确认变量配置

### 步骤 3: 网络分析
1. 点击"网络分析"标签页
2. 调整分析参数：
   - 网络阈值（推荐 0.05）
   - Bootstrap 次数（推荐 1000-5000）
   - 桥接分析设置（如果有多个变量组）
3. 点击"运行分析"
4. 查看网络图和中心性结果

### 步骤 4: 稳定性分析
1. 点击"稳定性分析"标签页
2. 运行独立的Bootstrap稳定性检验
3. 查看边稳定性和中心性稳定性图表

### 步骤 5: 结果解读
- **网络图**：节点大小表示中心性，边粗细表示关系强度
- **桥接网络**：方形节点表示桥接节点，连接不同心理构念
- **中心性分析**：识别网络中的核心节点
- **稳定性分析**：评估网络结构的可靠性

### 步骤 6: 结果下载
1. 点击"结果下载"标签页
2. 下载网络图、桥接网络图、中心性图、稳定性图
3. 下载分析数据和R代码脚本

## 应用架构

```
NetworkApp/
├── app.R              # 主应用文件（47KB+ 完整Shiny应用）
├── config.R           # 配置文件（量表定义、参数设置）
├── utils.R            # 工具函数库（数据处理、分析函数）
├── 安全启动.R          # 安全启动脚本（推荐使用）
├── run_app.R          # 完整启动脚本
├── README.md          # 本说明文档
├── CLAUDE.md          # Claude 代码助手指南
├── 最终使用说明.md     # 详细使用指南
└── example_data.csv   # 示例数据文件
```

### 应用界面结构（6个主要标签页）

1. **数据上传**：文件上传和数据验证
2. **变量选择** ⭐：专门的变量层级选择页面
3. **网络分析**：核心网络分析和可视化
4. **稳定性分析**：独立的Bootstrap稳定性检验
5. **结果下载**：图表和数据导出
6. **使用帮助**：说明文档

### 核心模块

1. **数据处理模块** (`utils.R`)
   - 自动量表识别：`parse_scale_structure_advanced()`
   - 数据验证：`validate_data()`
   - 维度得分计算：`compute_scale_scores_advanced()`

2. **网络分析模块** (`utils.R`)
   - 安全网络分析：`safe_network_analysis()`
   - 桥接网络分析：Bridge分析和bridgeGroup识别
   - 结果导出：`export_analysis_results()`

3. **配置管理模块** (`config.R`)
   - 量表结构定义：`SCALE_CONFIGS`
   - 分析参数：`NETWORK_PARAMS`
   - 可视化配置：`VIZ_CONFIG`

## 量表配置

应用内置了多种心理量表的配置，包括：

### HRF 量表维度结构
```
Habit (习惯动机): 题目 3, 6, 7, 10, 14, 16
Reward (奖赏动机): 题目 2, 4, 9, 12, 15, 17  
Fear (恐惧动机): 题目 1, 5, 8, 11, 13, 18
```

### AUDIT 量表计分
```
题目 1-8: 0-4 分
题目 9-10: 0-4 分（权重 ×2）
总分范围: 0-40 分
```

## 故障排除

### 常见问题

1. **包冲突错误**
   ```
   Error in abs(z) : non-numeric argument to mathematical function
   ```
   **解决方案**：使用安全启动脚本避免 bruceR 包冲突
   ```r
   source("安全启动.R", encoding = "UTF-8")
   ```

2. **包安装失败**
   ```r
   # 尝试更换 CRAN 镜像
   options(repos = c(CRAN = "https://cran.r-project.org/"))
   
   # 或使用清华镜像
   options(repos = c(CRAN = "https://mirrors.tuna.tsinghua.edu.cn/CRAN/"))
   ```

3. **quickNet 包无法安装**
   ```r
   # 检查网络连接，然后重试
   devtools::install_github("LeiGuo0812/quickNet", force = TRUE)
   ```

4. **数据无法识别**
   - 检查变量命名是否符合 `SCALE_NUMBER` 格式
   - 确保数据文件编码为 UTF-8
   - 验证数据格式和结构

5. **网络分析失败**
   - 检查样本量是否充足（≥30）
   - 验证变量方差是否为零
   - 确认数据完整性
   - 在变量选择页面查看数据质量警告

6. **showNotification 参数错误**
   ```
   'arg' should be one of "default", "message", "warning", "error"
   ```
   **解决方案**：使用安全启动脚本，应用已修复此问题

### 性能优化

- 对于大数据集（>1000 被试），建议：
  - 减少 Bootstrap 次数到 1000
  - 在条目层分析时注意变量数量（超过30个会有性能提示）
  - 稳定性分析可单独运行以节省时间

**⚠️ 重要原则**：
- 应用永远不会自动采样数据，始终使用完整数据集
- 大数据集仅给出性能提示，不进行数据缩减
- 保持分析结果的完整性和可重复性

## 技术支持

- **基础框架**: Shiny + shinydashboard
- **网络分析**: quickNet + qgraph
- **数据处理**: dplyr + readxl
- **可视化**: ggplot2 + plotly

## 更新日志

### v1.2.0 (2024-08-17) - 桥接网络分析版
- ✅ 新增桥接网络分析功能（Bridge Analysis）
- ✅ 支持多组别间桥接节点识别
- ✅ 桥接网络可视化（方形节点表示桥接节点）
- ✅ 桥接分析结果导出和下载功能
- ✅ 智能检测变量分组，自动启用桥接分析选项

### v1.1.0 (2024-08-17) - 数据质量评估版
- ✅ 新增完整观测数量实时显示功能
- ✅ 变量选择页面显示每个变量的缺失值统计
- ✅ 智能数据质量评估和分层提示系统
- ✅ 改进样本量不足的错误提示和建议
- ✅ 增强变量预览界面的信息密度

### v1.0.0 (2024-08-11) - 基础完成版
- ✅ 完整的6标签页应用架构
- ✅ 专门的变量选择页面和服务器端逻辑
- ✅ 解决bruceR包冲突问题
- ✅ 移除15条目硬限制，改为30节点建议
- ✅ 修复网络图显示问题
- ✅ 完整的多层级网络分析功能
- ✅ 独立的稳定性分析模块

## 贡献指南

欢迎贡献代码或提出建议：

1. 量表配置扩展（在 `config.R` 中添加新量表）
2. 分析功能增强（在 `utils.R` 中添加新函数）
3. 界面优化建议
4. 错误报告和修复

## 许可证

本项目基于原始 `toturial.R` 开发，遵循相同的许可协议。

---

📧 **联系方式**: 如有问题请通过 GitHub Issues 反馈

🌟 **致谢**: 感谢 开发quickNet 包的[郭垒](https://github.com/LeiGuo0812/quickNet)
